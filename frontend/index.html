<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>RAG Assistant â€” Login & Chat</title>

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --text: #111827;
      --text-muted: #6b7280;
      --border: #e5e7eb;
      --primary: #2563eb;
      --primary-hover: #1d4ed8;
      --danger: #ef4444;
      --shadow: 0 4px 10px rgba(0,0,0,0.08);
      --radius: 12px;
      --radius-sm: 8px;
      --transition: all 0.2s ease;
      --bot-bg: #e0e7ff;
      --user-bg: linear-gradient(135deg, #2563eb, #1e40af);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: Inter, system-ui, sans-serif;
      background: var(--bg);
      color: var(--text);
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    header {
      background: var(--primary);
      color: white;
      padding: 1rem 1.5rem;
      text-align: center;
      font-weight: 600;
      font-size: 1.25rem;
      box-shadow: var(--shadow);
    }

    main {
      flex: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1.5rem;
    }

    .auth-box {
      background: var(--card-bg);
      padding: 2rem;
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      width: 100%;
      max-width: 400px;
      animation: fadeIn 0.4s ease;
    }

    .auth-box h2 {
      text-align: center;
      font-size: 1.5rem;
      margin-bottom: 1.5rem;
      color: var(--text);
    }

    .auth-box input {
      width: 100%;
      padding: 0.75rem;
      margin-bottom: 1rem;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 1rem;
      transition: var(--transition);
    }
    .auth-box input:focus {
      border-color: var(--primary);
      outline: none;
      box-shadow: 0 0 0 3px rgba(37,99,235,0.2);
    }

    .auth-box button {
      width: 100%;
      padding: 0.75rem;
      background: var(--primary);
      color: white;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 1rem;
      font-weight: 500;
      cursor: pointer;
      transition: var(--transition);
    }
    .auth-box button:hover { background: var(--primary-hover); }

    .auth-error {
      color: var(--danger);
      min-height: 1.25rem;
      font-size: 0.875rem;
      margin-bottom: 0.5rem;
      text-align: center;
    }

    .auth-footer {
      text-align: center;
      margin-top: 1rem;
      color: var(--text-muted);
      font-size: 0.9rem;
    }
    .auth-footer a {
      color: var(--primary);
      text-decoration: none;
      font-weight: 500;
    }
    .auth-footer a:hover { text-decoration: underline; }
    .hidden { display: none !important; }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* Chat UI */
    #chatArea {
      display: flex;
      flex-direction: column;
      height: 100%;
      max-width: 800px;
      width: 100%;
      background: var(--card-bg);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    #chatBox {
      flex: 1;
      overflow-y: auto;
      padding: 1.25rem;
      display: flex;
      flex-direction: column;
      gap: 1rem;
      scroll-behavior: smooth;
    }

    .message {
      max-width: 80%;
      padding: 1rem 1.25rem;
      border-radius: 18px;
      line-height: 1.5;
      box-shadow: var(--shadow);
      word-break: break-word;
      font-size: 0.95rem;
    }
    .user {
      align-self: flex-end;
      background: var(--user-bg);
      color: white;
      border-bottom-right-radius: 6px;
    }
    .bot {
      align-self: flex-start;
      background: var(--bot-bg);
      color: var(--text);
      border-bottom-left-radius: 6px;
    }

    .input-area {
      display: flex;
      gap: 0.75rem;
      padding: 1rem;
      border-top: 1px solid var(--border);
      background: #f9fafb;
    }

    #queryInput {
      flex: 1;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      padding: 0.75rem 1rem;
      font-size: 1rem;
      outline: none;
      transition: var(--transition);
    }
    #queryInput:focus {
      border-color: var(--primary);
      box-shadow: 0 0 0 3px rgba(37,99,235,0.2);
    }

    #sendButton {
      width: 48px;
      height: 48px;
      border-radius: 50%;
      border: none;
      background: var(--primary);
      color: white;
      font-size: 1.25rem;
      cursor: pointer;
      transition: var(--transition);
    }
    #sendButton:hover { background: var(--primary-hover); }
    #sendButton:disabled { opacity: 0.6; cursor: not-allowed; }
  </style>

  <!-- Fixed: removed extra spaces in URL -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
</head>
<body>
  <header>ðŸ¤– RAG Assistant</header>

  <main>
    <!-- Login -->
    <div id="loginBox" class="auth-box">
      <h2>Welcome Back</h2>
      <input type="text" id="loginUsername" placeholder="Username" />
      <input type="password" id="loginPassword" placeholder="Password" />
      <button id="loginBtn">Login</button>
      <p id="loginError" class="auth-error"></p>
      <div class="auth-footer">Donâ€™t have an account? <a id="showSignup">Sign up</a></div>
    </div>

    <!-- Signup -->
    <div id="signupBox" class="auth-box hidden">
      <h2>Create Account</h2>
      <input type="text" id="signupUsername" placeholder="Username" />
      <input type="password" id="signupPassword" placeholder="Password" />
      <button id="signupBtn">Sign Up</button>
      <p id="signupError" class="auth-error"></p>
      <div class="auth-footer">Already have an account? <a id="showLogin">Login</a></div>
    </div>

    <!-- Chat -->
    <div id="chatArea" class="hidden">
      <div id="chatBox">
        <div class="message bot">ðŸ‘‹ <strong>Hello!</strong> Iâ€™m your <strong>RAG-powered assistant</strong>. How can I help you today?</div>
      </div>
      <div class="input-area">
        <input id="queryInput" type="text" placeholder="Type your question..." />
        <button id="sendButton">âž¤</button>
      </div>
    </div>
  </main>

  <script>
    const API_BASE = "http://localhost:5000";

    const TokenManager = {
      get access() { return localStorage.getItem("access_token"); },
      get refresh() { return localStorage.getItem("refresh_token"); },
      set(tokens) { 
        if (!tokens) return; 
        localStorage.setItem("access_token", tokens.access_token); 
        localStorage.setItem("refresh_token", tokens.refresh_token); 
      },
      clear() { 
        localStorage.removeItem("access_token"); 
        localStorage.removeItem("refresh_token"); 
      },
      async refreshToken() {
        if (!this.refresh) return null;
        try {
          const res = await fetch(`${API_BASE}/auth/refresh`, { 
            method: "POST", 
            headers: { "Content-Type": "application/json" }, 
            body: JSON.stringify({ refresh_token: this.refresh }) 
          });
          if (!res.ok) { 
            this.clear(); 
            return null; 
          }
          const data = await res.json();
          this.set(data.data || data);
          return data.data?.access_token || data.access_token;
        } catch { 
          this.clear(); 
          return null; 
        }
      }
    };

    const UI = {
      loginBox: document.getElementById("loginBox"),
      signupBox: document.getElementById("signupBox"),
      chatArea: document.getElementById("chatArea"),
      chatBox: document.getElementById("chatBox"),
      loginError: document.getElementById("loginError"),
      signupError: document.getElementById("signupError"),
      queryInput: document.getElementById("queryInput"),
      showLogin() { 
        this.loginBox.classList.remove("hidden"); 
        this.signupBox.classList.add("hidden"); 
        this.chatArea.classList.add("hidden"); 
      },
      showSignup() { 
        this.signupBox.classList.remove("hidden"); 
        this.loginBox.classList.add("hidden"); 
        this.chatArea.classList.add("hidden"); 
      },
      showChat() { 
        this.chatArea.classList.remove("hidden"); 
        this.loginBox.classList.add("hidden"); 
        this.signupBox.classList.add("hidden"); 
      },
      addMessage(sender, text) {
        const div = document.createElement("div");
        div.className = `message ${sender}`;
        // Sanitize & render Markdown
        div.innerHTML = marked.parse(text, { breaks: true });
        this.chatBox.appendChild(div);
        this.chatBox.scrollTop = this.chatBox.scrollHeight;
      },
      setError(type, msg) { 
        if (type === "login") this.loginError.textContent = msg;
        else this.signupError.textContent = msg; 
      }
    };

    async function apiPost(endpoint, body, auth = false) {
      let headers = { "Content-Type": "application/json" };
      let token = auth ? TokenManager.access : null;
      if (token) headers["Authorization"] = `Bearer ${token}`;
      
      let res = await fetch(`${API_BASE}${endpoint}`, {
        method: "POST",
        headers,
        body: JSON.stringify(body)
      });

      if (res.status === 401 && auth) {
        token = await TokenManager.refreshToken();
        if (!token) throw new Error("Session expired. Please log in again.");
        headers["Authorization"] = `Bearer ${token}`;
        res = await fetch(`${API_BASE}${endpoint}`, {
          method: "POST",
          headers,
          body: JSON.stringify(body)
        });
      }

      const data = await res.json().catch(() => ({}));
      if (!res.ok) throw new Error(data.message || data.detail || "Request failed");
      return data;
    }

    async function login() {
      const username = document.getElementById("loginUsername").value.trim();
      const password = document.getElementById("loginPassword").value.trim();
      if (!username || !password) return UI.setError("login", "Please fill all fields.");
      try { 
        const data = await apiPost("/auth/login", { username, password }); 
        TokenManager.set(data.data || data); 
        UI.showChat(); 
      } catch (err) { 
        UI.setError("login", err.message); 
      }
    }

    async function signup() {
      const username = document.getElementById("signupUsername").value.trim();
      const password = document.getElementById("signupPassword").value.trim();
      if (!username || !password) return UI.setError("signup", "Please fill all fields.");
      try {
        await apiPost("/auth/signup", { username, password });
        const data = await apiPost("/auth/login", { username, password });
        TokenManager.set(data.data || data); 
        UI.showChat();
      } catch (err) { 
        UI.setError("signup", err.message); 
      }
    }

    async function sendQuery() {
      const query = UI.queryInput.value.trim();
      if (!query) return;

      const sendBtn = document.getElementById("sendButton");
      sendBtn.disabled = true;
      UI.queryInput.disabled = true;

      UI.addMessage("user", query);
      UI.queryInput.value = "";
      UI.addMessage("bot", "ðŸ’­ Thinking...");

      try {
        const res = await apiPost("/query", { query }, true);

        // âœ… Correctly parse FastAPI response
        const finalAnswer = res?.data?.final_answer || "No answer found.";
        const agentsUsed = Array.isArray(res?.data?.agents_used)
          ? res.data.agents_used.join(", ")
          : "unknown";

        // Remove "Thinking..." message
        const messages = UI.chatBox.querySelectorAll(".message");
        if (messages.length > 0) {
          const last = messages[messages.length - 1];
          if (last.textContent.trim() === "ðŸ’­ Thinking...") {
            last.remove();
          }
        }

        const agentInfo = `<small style="color:#6b7280; display:block; margin-top:0.5rem;">(Agents used: ${agentsUsed})</small>`;
        UI.addMessage("bot", `${finalAnswer}${agentInfo}`);

      } catch (err) {
        // Remove "Thinking..." on error
        const messages = UI.chatBox.querySelectorAll(".message");
        if (messages.length > 0) {
          const last = messages[messages.length - 1];
          if (last.textContent.trim() === "ðŸ’­ Thinking...") {
            last.remove();
          }
        }

        UI.addMessage("bot", `âš ï¸ ${err.message}`);
        if (err.message.includes("Session expired")) {
          TokenManager.clear();
          UI.showLogin();
        }
      } finally {
        sendBtn.disabled = false;
        UI.queryInput.disabled = false;
        UI.queryInput.focus();
      }
    }

    // Event Listeners
    document.getElementById("loginBtn").onclick = login;
    document.getElementById("signupBtn").onclick = signup;
    document.getElementById("showSignup").onclick = () => UI.showSignup();
    document.getElementById("showLogin").onclick = () => UI.showLogin();
    document.getElementById("sendButton").onclick = sendQuery;
    UI.queryInput.onkeypress = e => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendQuery();
      }
    };

    // Initialize
    document.addEventListener("DOMContentLoaded", async () => {
      UI.showLogin();
      if (TokenManager.access) {
        try {
          await TokenManager.refreshToken();
          UI.showChat();
        } catch {
          TokenManager.clear();
          UI.showLogin();
        }
      }
    });
  </script>
</body>
</html>